# Azure DevOps Deployment Pipeline - Model Deployment
# Deploys trained model to Azure ML endpoints

trigger: none  # Manual trigger only

pr: none

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: mlflow  # Load Azure credentials from variable group
- name: pythonVersion
  value: '3.10'
- name: azureServiceConnection
  value: 'azure-ml-connection'
- name: modelName
  value: 'wine-quality-elasticnet'
- name: deploymentName
  value: 'wine-quality-endpoint'
- name: environment
  value: 'production'  # Can be: dev, staging, production

stages:
- stage: ValidateModel
  displayName: 'Validate Model'
  jobs:
  - job: CheckModel
    displayName: 'Check Model Registry'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
      displayName: 'Use Python $(pythonVersion)'

    - script: |
        pip install azureml-core mlflow
      displayName: 'Install dependencies'

    - task: AzureCLI@2
      displayName: 'Verify Model Exists'
      inputs:
        azureSubscription: '$(azureServiceConnection)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          az extension add -n ml -y
          
          # Get latest model version
          MODEL_VERSION=$(az ml model list --name $(modelName) \
            --resource-group $(AZURE_RESOURCE_GROUP) \
            --workspace-name $(AZURE_WORKSPACE_NAME) \
            --query "[0].version" -o tsv)
          
          echo "Latest model version: $MODEL_VERSION"
          echo "##vso[task.setvariable variable=modelVersion;isOutput=true]$MODEL_VERSION"
      name: modelInfo

- stage: DeployToStaging
  displayName: 'Deploy to Staging'
  dependsOn: ValidateModel
  condition: succeeded()
  jobs:
  - deployment: DeployStaging
    displayName: 'Deploy to Staging Environment'
    environment: 'staging'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
            displayName: 'Use Python $(pythonVersion)'

          - script: |
              pip install azureml-core azure-ai-ml
            displayName: 'Install Azure ML SDK'

          - task: AzureCLI@2
            displayName: 'Create/Update Staging Endpoint'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az extension add -n ml -y
                
                ENDPOINT_NAME="wine-quality-staging"
                
                # Create endpoint if it doesn't exist
                az ml online-endpoint create \
                  --name $ENDPOINT_NAME \
                  --resource-group $(AZURE_RESOURCE_GROUP) \
                  --workspace-name $(AZURE_WORKSPACE_NAME) || true
                
                echo "Staging endpoint ready: $ENDPOINT_NAME"

          - task: AzureCLI@2
            displayName: 'Deploy Model to Staging'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Model deployment to staging would happen here"
                echo "Deploying model: $(modelName)"

- stage: TestStaging
  displayName: 'Test Staging Deployment'
  dependsOn: DeployToStaging
  jobs:
  - job: SmokeTests
    displayName: 'Run Smoke Tests'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
      displayName: 'Use Python $(pythonVersion)'

    - script: |
        pip install requests pandas
      displayName: 'Install test dependencies'

    - task: AzureCLI@2
      displayName: 'Test Staging Endpoint'
      inputs:
        azureSubscription: '$(azureServiceConnection)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          # Test the deployed model with sample data
          echo "Running smoke tests against staging endpoint..."
          echo "Testing wine quality predictions..."
          # Add actual endpoint testing here

- stage: ApprovalGate
  displayName: 'Manual Approval'
  dependsOn: TestStaging
  jobs:
  - job: WaitForApproval
    displayName: 'Waiting for Production Approval'
    pool: server
    timeoutInMinutes: 4320  # 3 days
    steps:
    - task: ManualValidation@0
      inputs:
        notifyUsers: 'your-email@example.com'
        instructions: 'Please validate staging deployment before promoting to production'

- stage: DeployToProduction
  displayName: 'Deploy to Production'
  dependsOn: ApprovalGate
  condition: succeeded()
  jobs:
  - deployment: DeployProduction
    displayName: 'Deploy to Production Environment'
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
            displayName: 'Use Python $(pythonVersion)'

          - script: |
              pip install azureml-core azure-ai-ml
            displayName: 'Install Azure ML SDK'

          - task: AzureCLI@2
            displayName: 'Deploy to Production Endpoint'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az extension add -n ml -y
                
                ENDPOINT_NAME="wine-quality-prod"
                
                # Create/update production endpoint
                az ml online-endpoint create \
                  --name $ENDPOINT_NAME \
                  --resource-group $(AZURE_RESOURCE_GROUP) \
                  --workspace-name $(AZURE_WORKSPACE_NAME) || true
                
                echo "Production deployment completed"
                echo "Endpoint: $ENDPOINT_NAME"

          - script: |
              echo "==================================="
              echo "PRODUCTION DEPLOYMENT SUCCESSFUL"
              echo "==================================="
              echo "Model: $(modelName)"
              echo "Endpoint: wine-quality-prod"
            displayName: 'Deployment Summary'
