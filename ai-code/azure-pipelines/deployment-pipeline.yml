# Azure DevOps Deployment Pipeline - Model Deployment
# Deploys trained model to Azure ML endpoints

trigger: none  # Manual trigger only

pr: none

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: mlflow  # Load Azure credentials from variable group
- name: pythonVersion
  value: '3.10'
- name: modelName
  value: 'wine-quality-elasticnet'
- name: deploymentName
  value: 'wine-quality-endpoint'
- name: environment
  value: 'production'  # Can be: dev, staging, production

stages:
- stage: ValidateModel
  displayName: 'Validate Model'
  jobs:
  - job: CheckModel
    displayName: 'Check Model Registry'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
      displayName: 'Use Python $(pythonVersion)'

    - script: |
        pip install azureml-core mlflow
      displayName: 'Install dependencies'

    - script: |
        # Login with service principal
        az login --service-principal \
          --username $(TF_VAR_AZURE_CLIENT_ID) \
          --password $(TF_VAR_AZURE_CLIENT_SECRET) \
          --tenant $(TF_VAR_AZURE_TENANT_ID)
        
        az account set --subscription $(TF_VAR_AZURE_SUBSCRIPTION_ID)
        az extension add -n ml -y
        
        # Get latest model version
        MODEL_VERSION=$(az ml model list --name $(modelName) \
          --resource-group $(AZURE_RESOURCE_GROUP) \
          --workspace-name $(AZURE_WORKSPACE_NAME) \
          --query "[0].version" -o tsv)
        
        echo "Latest model version: $MODEL_VERSION"
        echo "##vso[task.setvariable variable=modelVersion;isOutput=true]$MODEL_VERSION"
      displayName: 'Verify Model Exists'
      name: modelInfo

- stage: DeployToStaging
  displayName: 'Deploy to Staging'
  dependsOn: ValidateModel
  condition: succeeded()
  jobs:
  - job: DeployStaging
    displayName: 'Deploy to Staging Environment'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
      displayName: 'Use Python $(pythonVersion)'

    - script: |
        pip install azureml-core azure-ai-ml
      displayName: 'Install Azure ML SDK'

    - script: |
        # Login with service principal
        az login --service-principal \
          --username $(TF_VAR_AZURE_CLIENT_ID) \
          --password $(TF_VAR_AZURE_CLIENT_SECRET) \
          --tenant $(TF_VAR_AZURE_TENANT_ID)
        
        az account set --subscription $(TF_VAR_AZURE_SUBSCRIPTION_ID)
        az extension add -n ml -y
        
        ENDPOINT_NAME="wine-quality-staging"
        
        # Create endpoint if it doesn't exist
        az ml online-endpoint create \
          --name $ENDPOINT_NAME \
          --resource-group $(AZURE_RESOURCE_GROUP) \
          --workspace-name $(AZURE_WORKSPACE_NAME) || true
        
        echo "Staging endpoint ready: $ENDPOINT_NAME"
      displayName: 'Create/Update Staging Endpoint'

    - script: |
        echo "Model deployment to staging would happen here"
        echo "Deploying model: $(modelName)"
      displayName: 'Deploy Model to Staging'

- stage: TestStaging
  displayName: 'Test Staging Deployment'
  dependsOn: DeployToStaging
  jobs:
  - job: SmokeTests
    displayName: 'Run Smoke Tests'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
      displayName: 'Use Python $(pythonVersion)'

    - script: |
        pip install requests pandas
      displayName: 'Install test dependencies'

    - script: |
        # Login with service principal
        az login --service-principal \
          --username $(TF_VAR_AZURE_CLIENT_ID) \
          --password $(TF_VAR_AZURE_CLIENT_SECRET) \
          --tenant $(TF_VAR_AZURE_TENANT_ID)
        
        az account set --subscription $(TF_VAR_AZURE_SUBSCRIPTION_ID)
        
        # Test the deployed model with sample data
        echo "Running smoke tests against staging endpoint..."
        echo "Testing wine quality predictions..."
        # Add actual endpoint testing here
      displayName: 'Test Staging Endpoint'

- stage: ApprovalGate
  displayName: 'Manual Approval'
  dependsOn: TestStaging
  jobs:
  - job: WaitForApproval
    displayName: 'Waiting for Production Approval'
    pool: server
    timeoutInMinutes: 4320  # 3 days
    steps:
    - task: ManualValidation@0
      inputs:
        notifyUsers: 'your-email@example.com'
        instructions: 'Please validate staging deployment before promoting to production'

- stage: DeployToProduction
  displayName: 'Deploy to Production'
  dependsOn: ApprovalGate
  condition: succeeded()
  jobs:
  - job: DeployProduction
    displayName: 'Deploy to Production Environment'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
      displayName: 'Use Python $(pythonVersion)'

    - script: |
        pip install azureml-core azure-ai-ml
      displayName: 'Install Azure ML SDK'

    - script: |
        # Login with service principal
        az login --service-principal \
          --username $(TF_VAR_AZURE_CLIENT_ID) \
          --password $(TF_VAR_AZURE_CLIENT_SECRET) \
          --tenant $(TF_VAR_AZURE_TENANT_ID)
        
        az account set --subscription $(TF_VAR_AZURE_SUBSCRIPTION_ID)
        az extension add -n ml -y
        
        ENDPOINT_NAME="wine-quality-prod"
        
        # Create/update production endpoint
        az ml online-endpoint create \
          --name $ENDPOINT_NAME \
          --resource-group $(AZURE_RESOURCE_GROUP) \
          --workspace-name $(AZURE_WORKSPACE_NAME) || true
        
        echo "Production deployment completed"
        echo "Endpoint: $ENDPOINT_NAME"
      displayName: 'Deploy to Production Endpoint'

    - script: |
        echo "==================================="
        echo "PRODUCTION DEPLOYMENT SUCCESSFUL"
        echo "==================================="
        echo "Model: $(modelName)"
        echo "Endpoint: wine-quality-prod"
      displayName: 'Deployment Summary'
