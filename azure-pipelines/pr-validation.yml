# Pull Request Validation Pipeline
# Runs on PRs to validate experiment changes before merging

trigger: none  # Only PR trigger

pr:
  branches:
    include:
    - main
    - develop
  paths:
    include:
    - ai-code/*.py
    - data/*.csv
    - ai-code/requirements.txt

pool:
  vmImage: 'ubuntu-latest'

variables:
  pythonVersion: '3.11'

jobs:
- job: ValidateCode
  displayName: 'Validate Python Code'
  steps:
  - task: UsePythonVersion@0
    displayName: 'Use Python $(pythonVersion)'
    inputs:
      versionSpec: '$(pythonVersion)'
  
  - script: |
      pip install flake8 pylint
    displayName: 'Install Linting Tools'
  
  - script: |
      # Lint Python files
      flake8 ai-code/*.py --max-line-length=100 --ignore=E501,W503 || true
      echo "Linting completed"
    displayName: 'Lint Python Code'
    continueOnError: true

- job: TestExperiments
  displayName: 'Test Experiments'
  dependsOn: ValidateCode
  steps:
  - task: UsePythonVersion@0
    displayName: 'Use Python $(pythonVersion)'
    inputs:
      versionSpec: '$(pythonVersion)'
  
  - script: |
      pip install -r ai-code/requirements.txt
    displayName: 'Install Dependencies'
  
  - script: |
      cd ai-code
      # Run with reduced iterations for PR validation
      timeout 300 python experiment_series.py || echo "Experiment timed out (expected for PR)"
    displayName: 'Quick Experiment Test'
    continueOnError: true
  
  - script: |
      # Check if MLflow tracking worked
      if [ -d "ai-code/mlruns" ]; then
        echo "✓ MLflow tracking directory created"
        ls -la ai-code/mlruns/
      else
        echo "⚠ No MLflow tracking directory found"
        exit 1
      fi
    displayName: 'Validate MLflow Output'
  
  - task: PublishPipelineArtifact@1
    displayName: 'Publish PR Test Results'
    inputs:
      targetPath: '$(System.DefaultWorkingDirectory)/ai-code/mlruns'
      artifact: 'pr-test-results'
    condition: succeededOrFailed()

- job: ReportResults
  displayName: 'Report PR Validation Results'
  dependsOn: TestExperiments
  condition: always()
  steps:
  - script: |
      echo "========================================"
      echo "PR Validation Complete"
      echo "========================================"
      echo ""
      echo "Code validation: See 'ValidateCode' job"
      echo "Experiment test: See 'TestExperiments' job"
      echo ""
      echo "Next steps:"
      echo "1. Review validation results above"
      echo "2. Fix any issues found"
      echo "3. Re-push to trigger new validation"
      echo "4. Merge PR when all checks pass"
      echo ""
      echo "========================================"
    displayName: 'Summary'
