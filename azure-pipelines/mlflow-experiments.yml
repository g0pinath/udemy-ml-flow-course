# Azure DevOps Pipeline for MLflow Experiments
# This pipeline runs wine quality prediction experiments and publishes results

trigger:
  branches:
    include:
    - main
    - develop
  paths:
    include:
    - ai-code/experiments/*
    - ai-code/scripts/*
    - ai-code/config/*
    - data/*
    - azure-pipelines/mlflow-experiments.yml

pr:
  branches:
    include:
    - main
    - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
- name: pythonVersion
  value: '3.11'  # Using 3.11 for better compatibility with Azure ML SDK
- name: workingDirectory
  value: '$(System.DefaultWorkingDirectory)'
- group: mlflow  # Azure ML service principal credentials
  
stages:
- stage: Setup
  displayName: 'Setup Environment'
  jobs:
  - job: ValidateEnvironment
    displayName: 'Validate and Setup Python Environment'
    steps:
    - task: UsePythonVersion@0
      displayName: 'Use Python $(pythonVersion)'
      inputs:
        versionSpec: '$(pythonVersion)'
        addToPath: true
    
    - script: |
        python --version
        pip --version
      displayName: 'Display Python and Pip Versions'
    
    - script: |
        python -m pip install --upgrade pip
        pip install -r ai-code/config/requirements.txt
      displayName: 'Install Python Dependencies'
      workingDirectory: '$(workingDirectory)'
    
    - script: |
        pip list
      displayName: 'List Installed Packages'

- stage: RunExperiments
  displayName: 'Run MLflow Experiments'
  dependsOn: Setup
  jobs:
  - job: ComprehensiveExperiments
    displayName: 'Run Comprehensive Experiment Suite'
    steps:
    - task: UsePythonVersion@0
      displayName: 'Use Python $(pythonVersion)'
      inputs:
        versionSpec: '$(pythonVersion)'
        addToPath: true
    
    - script: |
        python -m pip install --upgrade pip
        pip install -r ai-code/config/requirements.txt
      displayName: 'Install Dependencies'
      workingDirectory: '$(workingDirectory)'
    
    - script: |
        cd ai-code
        python experiments/wine_quality_comprehensive.py
      displayName: 'Run Comprehensive Experiment Suite with Azure ML'
      env:
        AZURE_TENANT_ID: $(TF_VAR_AZURE_TENANT_ID)
        AZURE_CLIENT_ID: $(TF_VAR_AZURE_CLIENT_ID)
        AZURE_CLIENT_SECRET: $(TF_VAR_AZURE_CLIENT_SECRET)
        AZURE_SUBSCRIPTION_ID: $(TF_VAR_AZURE_SUBSCRIPTION_ID)
    
    - script: |
        echo "Experiments logged to Azure ML workspace"
        echo "View results at: https://ml.azure.com"
      displayName: 'Display Azure ML Results Link'

- stage: PublishResults
  displayName: 'Publish Experiment Results'
  dependsOn: RunExperiments
  jobs:
  - job: GenerateReports
    displayName: 'Generate Experiment Summary'
    steps:
    - script: |
        echo "================================================"
        echo "MLflow Experiments Complete!"
        echo "================================================"
        echo "All experiment results are logged to Azure ML workspace"
        echo ""
        echo "View results at:"
        echo "https://ml.azure.com"
        echo ""
        echo "Navigate to: Experiments â†’ wine-quality-comprehensive-optimization"
        echo "================================================"
      displayName: 'Display Summary'
