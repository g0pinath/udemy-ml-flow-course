# Azure DevOps Pipeline for MLflow Experiments
# This pipeline runs wine quality prediction experiments and publishes results

trigger:
  branches:
    include:
    - main
    - develop
  paths:
    include:
    - ai-code/*
    - data/*
    - azure-pipelines/mlflow-experiments.yml

pr:
  branches:
    include:
    - main
    - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  pythonVersion: '3.11'  # Using 3.11 for better compatibility with Azure ML SDK
  workingDirectory: '$(System.DefaultWorkingDirectory)'
  
stages:
- stage: Setup
  displayName: 'Setup Environment'
  jobs:
  - job: ValidateEnvironment
    displayName: 'Validate and Setup Python Environment'
    steps:
    - task: UsePythonVersion@0
      displayName: 'Use Python $(pythonVersion)'
      inputs:
        versionSpec: '$(pythonVersion)'
        addToPath: true
    
    - script: |
        python --version
        pip --version
      displayName: 'Display Python and Pip Versions'
    
    - script: |
        python -m pip install --upgrade pip
        pip install -r ai-code/requirements.txt
      displayName: 'Install Python Dependencies'
      workingDirectory: '$(workingDirectory)'
    
    - script: |
        pip list
      displayName: 'List Installed Packages'

- stage: RunExperiments
  displayName: 'Run MLflow Experiments'
  dependsOn: Setup
  jobs:
  - job: ComprehensiveExperiments
    displayName: 'Run Comprehensive Experiment Suite'
    steps:
    - task: UsePythonVersion@0
      displayName: 'Use Python $(pythonVersion)'
      inputs:
        versionSpec: '$(pythonVersion)'
        addToPath: true
    
    - script: |
        python -m pip install --upgrade pip
        pip install -r ai-code/requirements.txt
      displayName: 'Install Dependencies'
      workingDirectory: '$(workingDirectory)'
    
    - script: |
        cd ai-code
        python wine_quality_comprehensive.py
      displayName: 'Run Comprehensive Experiment Suite'
      env:
        USE_AZURE_ML: 'False'  # Use local tracking in pipeline
    
    - task: PublishPipelineArtifact@1
      displayName: 'Publish MLflow Comprehensive Results'
      inputs:
        targetPath: '$(workingDirectory)/ai-code/mlruns'
        artifact: 'mlflow-comprehensive-results'
        publishLocation: 'pipeline'

- stage: PublishResults
  displayName: 'Publish Experiment Results'
  dependsOn: RunExperiments
  jobs:
  - job: GenerateReports
    displayName: 'Generate Experiment Reports'
    steps:
    - task: UsePythonVersion@0
      displayName: 'Use Python $(pythonVersion)'
      inputs:
        versionSpec: '$(pythonVersion)'
        addToPath: true
    
    - script: |
        python -m pip install --upgrade pip
        pip install mlflow pandas matplotlib seaborn
      displayName: 'Install MLflow and Reporting Dependencies'
    
    - task: DownloadPipelineArtifact@2
      displayName: 'Download Comprehensive Results'
      inputs:
        artifact: 'mlflow-comprehensive-results'
        path: '$(workingDirectory)/results/comprehensive'
    
    - script: |
        cd results/comprehensive
        python -m mlflow ui --port 5000 --backend-store-uri file:./mlruns &
        sleep 5
        echo "MLflow UI started for comprehensive results"
      displayName: 'Start MLflow UI'
      continueOnError: true
    
    - script: |
        python azure-pipelines/scripts/generate_summary_report.py
      displayName: 'Generate Summary Report'
      continueOnError: true
    
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Summary Report'
      inputs:
        targetPath: '$(workingDirectory)/reports'
        artifact: 'experiment-summary-reports'
        publishLocation: 'pipeline'
      condition: succeededOrFailed()
    
    - task: PublishTestResults@2
      displayName: 'Publish Experiment Metrics as Test Results'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/experiment-results.xml'
        searchFolder: '$(workingDirectory)/reports'
        mergeTestResults: true
        failTaskOnFailedTests: false
        testRunTitle: 'MLflow Experiment Results'
      condition: succeededOrFailed()

- stage: CleanupAndArchive
  displayName: 'Cleanup and Archive'
  dependsOn: PublishResults
  condition: always()
  jobs:
  - job: ArchiveResults
    displayName: 'Archive Experiment Results'
    steps:
    - task: DownloadPipelineArtifact@2
      displayName: 'Download All Artifacts'
      inputs:
        path: '$(workingDirectory)/all-results'
    
    - task: ArchiveFiles@2
      displayName: 'Archive MLflow Results'
      inputs:
        rootFolderOrFile: '$(workingDirectory)/all-results'
        includeRootFolder: true
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/mlflow-experiments-$(Build.BuildNumber).zip'
        replaceExistingArchive: true
    
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Archived Results'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/mlflow-experiments-$(Build.BuildNumber).zip'
        ArtifactName: 'mlflow-experiments-archive'
        publishLocation: 'Container'
